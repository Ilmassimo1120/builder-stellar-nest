<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storage Limit Test - ChargeSource</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        margin-bottom: 30px;
        text-align: center;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .bucket-test {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .bucket-test h2 {
        font-size: 20px;
        margin-bottom: 15px;
        color: #333;
      }

      .bucket-name {
        font-size: 12px;
        color: #999;
        margin-bottom: 20px;
        padding: 8px 12px;
        background: #f5f5f5;
        border-radius: 4px;
        font-family: monospace;
      }

      .test-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }

      button {
        padding: 12px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
      }

      .status {
        margin: 15px 0;
        padding: 12px;
        border-radius: 6px;
        font-size: 13px;
      }

      .status.success {
        background: #e8f5e9;
        color: #2e7d32;
        border-left: 4px solid #4caf50;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
      }

      .status.warning {
        background: #fff3e0;
        color: #e65100;
        border-left: 4px solid #ff9800;
      }

      .status.info {
        background: #e3f2fd;
        color: #1565c0;
        border-left: 4px solid #2196f3;
      }

      .progress-container {
        margin: 15px 0;
      }

      .progress-label {
        font-size: 12px;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        color: #666;
      }

      .progress-bar {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s ease;
      }

      .progress-fill.warning {
        background: linear-gradient(90deg, #ff9800, #f44336);
      }

      .file-list {
        background: #f9f9f9;
        border-radius: 6px;
        padding: 12px;
        margin-top: 15px;
      }

      .file-item {
        padding: 8px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 12px;
      }

      .file-item:last-child {
        border-bottom: none;
      }

      .file-name {
        font-weight: 600;
        color: #333;
      }

      .file-size {
        color: #999;
        font-size: 11px;
      }

      .summary {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .summary h2 {
        margin-bottom: 15px;
        color: #333;
      }

      .summary-item {
        padding: 12px;
        margin-bottom: 10px;
        background: #f5f5f5;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .summary-label {
        font-weight: 600;
        color: #333;
      }

      .summary-value {
        color: #667eea;
        font-weight: 600;
      }

      .cleanup-btn {
        background: #ff6b6b;
        color: white;
        margin-top: 20px;
        width: 100%;
      }

      .cleanup-btn:hover {
        background: #ee5a52;
      }

      .test-size-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 15px;
      }

      .test-size-btn {
        padding: 10px;
        font-size: 12px;
        background: #e0e0e0;
        border: 2px solid transparent;
      }

      .test-size-btn.active {
        background: #667eea;
        color: white;
        border-color: #5568d3;
      }

      .timestamp {
        font-size: 11px;
        color: #999;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ü™£ Supabase Storage Limit Test - 50MB Per Bucket</h1>

      <div class="grid" id="bucketTests"></div>

      <div class="summary">
        <h2>üìä Test Summary</h2>
        <div id="summaryContent">
          <div class="summary-item">
            <span class="summary-label">Total Storage Used:</span>
            <span class="summary-value">0 MB / 150 MB</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Buckets Tested:</span>
            <span class="summary-value">0 / 3</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Status:</span>
            <span class="summary-value">Ready</span>
          </div>
        </div>
        <button class="btn-primary" onclick="runAllTests()" style="margin-top: 20px; width: 100%;">
          üöÄ Run All Limit Tests
        </button>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://tepmkljodsifaexmrinl.supabase.co";
      const ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlcG1rbGpvZHNpZmFleG1yaW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MDQwMjUsImV4cCI6MjA3MDE4MDAyNX0.n4WdeHUHHc5PuJV8-2oDn826CoNxNzHHbt4KxeAhOYc";

      const supabase = window.supabase.createClient(SUPABASE_URL, ANON_KEY);

      const BUCKETS = [
        {
          name: "charge-source-user-files",
          limit: 50 * 1024 * 1024, // 50MB
          description: "Personal/user files",
        },
        {
          name: "charge-source-documents",
          limit: 50 * 1024 * 1024, // 50MB (testing)
          description: "Official documents",
        },
        {
          name: "charge-source-videos",
          limit: 50 * 1024 * 1024, // 50MB (testing)
          description: "Training videos",
        },
      ];

      const TEST_SIZES = [
        { label: "1 MB", size: 1 * 1024 * 1024 },
        { label: "5 MB", size: 5 * 1024 * 1024 },
        { label: "10 MB", size: 10 * 1024 * 1024 },
        { label: "20 MB", size: 20 * 1024 * 1024 },
      ];

      let bucketStates = {};

      function initializeBuckets() {
        const container = document.getElementById("bucketTests");
        container.innerHTML = "";

        BUCKETS.forEach((bucket, index) => {
          bucketStates[bucket.name] = {
            files: [],
            totalSize: 0,
            testSize: TEST_SIZES[0].size,
            isTestRunning: false,
          };

          const bucketHtml = `
            <div class="bucket-test">
              <h2>${bucket.name}</h2>
              <div class="bucket-name">${bucket.description}</div>
              
              <div class="test-size-selector">
                ${TEST_SIZES.map(
                  (testSize) => `
                  <button class="btn-secondary test-size-btn" 
                    onclick="setTestSize('${bucket.name}', ${testSize.size})">
                    ${testSize.label}
                  </button>
                `
                ).join("")}
              </div>

              <div class="test-buttons">
                <button class="btn-primary" onclick="uploadTestFile('${bucket.name}')">
                  üì§ Upload Test File
                </button>
                <button class="btn-secondary" onclick="listBucketFiles('${bucket.name}')">
                  üìã List Files
                </button>
              </div>

              <div id="status-${bucket.name}"></div>

              <div class="progress-container">
                <div class="progress-label">
                  <span>Storage Usage</span>
                  <span id="usage-${bucket.name}">0 / 50 MB</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progress-${bucket.name}" style="width: 0%"></div>
                </div>
              </div>

              <div class="file-list" id="files-${bucket.name}" style="display: none;">
                <strong>Files in bucket:</strong>
                <div id="file-list-${bucket.name}"></div>
              </div>

              <button class="btn-secondary" style="width: 100%; margin-top: 15px;" 
                onclick="cleanupBucket('${bucket.name}')">
                üóëÔ∏è Clean Up Test Files
              </button>
            </div>
          `;

          container.innerHTML += bucketHtml;
        });
      }

      function setTestSize(bucketName, size) {
        bucketStates[bucketName].testSize = size;

        // Update UI
        document.querySelectorAll(`.test-size-btn`).forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        const sizeMB = (size / (1024 * 1024)).toFixed(1);
        addStatus(bucketName, `Test file size set to: ${sizeMB} MB`, "info");
      }

      function generateTestFile(size) {
        const chunk = new Uint8Array(Math.min(size, 1024 * 1024)); // 1MB chunks
        for (let i = 0; i < chunk.length; i++) {
          chunk[i] = Math.floor(Math.random() * 256);
        }

        const chunks = [];
        for (let i = 0; i < size; i += chunk.length) {
          chunks.push(chunk);
        }

        return new Blob(chunks, { type: "application/octet-stream" });
      }

      async function uploadTestFile(bucketName) {
        const state = bucketStates[bucketName];
        if (state.isTestRunning) {
          addStatus(bucketName, "Test already running...", "warning");
          return;
        }

        state.isTestRunning = true;
        const testSize = state.testSize;
        const sizeMB = (testSize / (1024 * 1024)).toFixed(1);
        const fileName = `test-${Date.now()}-${sizeMB}mb.bin`;

        try {
          addStatus(bucketName, `Generating ${sizeMB} MB test file...`, "info");

          const testFile = generateTestFile(testSize);

          addStatus(bucketName, `Uploading ${sizeMB} MB file...`, "info");

          const { data, error } = await supabase.storage
            .from(bucketName)
            .upload(fileName, testFile);

          if (error) {
            addStatus(
              bucketName,
              `‚ùå Upload failed: ${error.message}`,
              "error"
            );
            console.error("Upload error:", error);
          } else {
            addStatus(
              bucketName,
              `‚úÖ Successfully uploaded ${sizeMB} MB file`,
              "success"
            );
            await listBucketFiles(bucketName);
          }
        } catch (error) {
          addStatus(bucketName, `‚ùå Error: ${error.message}`, "error");
          console.error("Test error:", error);
        } finally {
          state.isTestRunning = false;
        }
      }

      async function listBucketFiles(bucketName) {
        try {
          const { data, error } = await supabase.storage
            .from(bucketName)
            .list("", { limit: 100, sortBy: { column: "created_at", order: "desc" } });

          if (error) {
            addStatus(bucketName, `‚ùå List error: ${error.message}`, "error");
            return;
          }

          const state = bucketStates[bucketName];
          state.files = data || [];
          state.totalSize = data.reduce((acc, f) => acc + (f.metadata?.size || 0), 0);

          updateProgress(bucketName);
          displayFiles(bucketName);
          addStatus(
            bucketName,
            `‚úÖ Found ${data.length} files (${formatBytes(state.totalSize)} total)`,
            "success"
          );
        } catch (error) {
          addStatus(bucketName, `‚ùå Error: ${error.message}`, "error");
        }
      }

      function displayFiles(bucketName) {
        const state = bucketStates[bucketName];
        const filesContainer = document.getElementById(`files-${bucketName}`);
        const fileList = document.getElementById(`file-list-${bucketName}`);

        if (state.files.length === 0) {
          filesContainer.style.display = "none";
          return;
        }

        filesContainer.style.display = "block";
        fileList.innerHTML = state.files
          .map(
            (file) => `
          <div class="file-item">
            <div class="file-name">${file.name}</div>
            <div class="file-size">${formatBytes(file.metadata?.size || 0)}</div>
            <div class="timestamp">${new Date(file.created_at).toLocaleString()}</div>
          </div>
        `
          )
          .join("");
      }

      function updateProgress(bucketName) {
        const state = bucketStates[bucketName];
        const limit = 50 * 1024 * 1024; // 50MB
        const percentage = Math.min((state.totalSize / limit) * 100, 100);
        const usageMB = (state.totalSize / (1024 * 1024)).toFixed(1);

        document.getElementById(`progress-${bucketName}`).style.width = percentage + "%";
        document.getElementById(`progress-${bucketName}`).classList.toggle("warning", percentage > 80);
        document.getElementById(`usage-${bucketName}`).textContent = `${usageMB} / 50 MB`;

        if (percentage >= 100) {
          addStatus(bucketName, "‚ö†Ô∏è Bucket at 50MB limit!", "warning");
        }
      }

      async function cleanupBucket(bucketName) {
        if (!confirm(`Delete all test files in ${bucketName}?`)) return;

        try {
          const state = bucketStates[bucketName];
          const fileNames = state.files.map((f) => f.name);

          if (fileNames.length === 0) {
            addStatus(bucketName, "No files to delete", "info");
            return;
          }

          const { error } = await supabase.storage
            .from(bucketName)
            .remove(fileNames);

          if (error) {
            addStatus(bucketName, `‚ùå Cleanup failed: ${error.message}`, "error");
          } else {
            state.files = [];
            state.totalSize = 0;
            updateProgress(bucketName);
            displayFiles(bucketName);
            addStatus(bucketName, `‚úÖ Deleted ${fileNames.length} files`, "success");
          }
        } catch (error) {
          addStatus(bucketName, `‚ùå Error: ${error.message}`, "error");
        }
      }

      async function runAllTests() {
        addStatus("all", "Starting comprehensive storage tests...", "info");

        for (const bucket of BUCKETS) {
          addStatus(bucket.name, "Running test...", "info");
          
          // Test 1MB upload
          setTestSize(bucket.name, TEST_SIZES[0].size);
          await uploadTestFile(bucket.name);
          await new Promise((r) => setTimeout(r, 1000));

          // List files
          await listBucketFiles(bucket.name);
        }

        addStatus("all", "Tests completed! Check storage usage above.", "success");
      }

      function addStatus(bucketName, message, type) {
        const container = document.getElementById(`status-${bucketName}`);
        if (!container) return;

        const status = document.createElement("div");
        status.className = `status ${type}`;
        status.textContent = message;
        container.innerHTML = "";
        container.appendChild(status);

        if (bucketName === "all") {
          console.log(message);
        }
      }

      function formatBytes(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
      }

      // Initialize on load
      window.addEventListener("load", () => {
        initializeBuckets();
        document.querySelectorAll(".test-size-btn")[0].classList.add("active");
      });
    </script>
  </body>
</html>
